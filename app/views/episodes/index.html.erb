<% content_for :title, "Episode finder" %>

<div class="page">
  <section class="hero">
    <p class="eyebrow">TV episode finder</p>
    <h1>Search a curated set of episodes</h1>
    <p class="lede">Type a show name, episode title, or a plot detail to look up the episodes we currently track.</p>

    <% selected_show = @show_id.present? ? @shows.detect { |show| show.id == @show_id.to_i } : nil %>
    <% selected_emoji = selected_show&.emoji.presence || (selected_show ? "üì∫" : "‚ú≥Ô∏è") %>

    <%= form_with url: root_path, method: :get, data: { turbo_frame: "episode_results", controller: "live-search voice-search", action: "input->live-search#queue change->live-search#queue", "live-search-delay-value": 400, "voice-search-endpoint-value": voice_search_path, "voice-search-max-duration-value": 12 }, class: "search-form" do |form| %>
      <div class="search-box">
        <button type="button" class="voice-button" data-voice-search-target="button" data-action="click->voice-search#toggle" aria-label="Start voice search" aria-pressed="false">
          <span class="voice-icon" aria-hidden="true">üéôÔ∏è</span>
          <span class="voice-label">Voice</span>
          <span class="voice-pulse" aria-hidden="true"></span>
        </button>

        <div class="search-input-group">
          <%= form.label :q, "Search", class: "sr-only" %>
          <%= form.search_field :q, value: @query, placeholder: "e.g. Dinner Party, plane crash, Hawkins lab", autofocus: true, class: "search-input", data: { "voice-search-target": "input" } %>
        </div>

        <div class="show-picker" data-controller="show-picker">
          <%= form.hidden_field :show_id, value: @show_id, data: { "show-picker-target": "input" } %>
          <button type="button" class="show-picker-trigger" data-show-picker-target="trigger" data-action="click->show-picker#toggle">
            <span class="emoji" data-show-picker-target="emoji"><%= selected_emoji %></span>
            <span class="label">
              <span class="muted small">Show</span>
              <strong data-show-picker-target="name"><%= selected_show&.name || "All shows" %></strong>
            </span>
            <span class="chevron">‚ñæ</span>
          </button>

          <div class="show-picker-backdrop" data-show-picker-target="backdrop" data-action="click->show-picker#close" hidden></div>
          <div class="show-picker-menu" data-show-picker-target="menu" hidden>
            <div class="show-picker-header">
              <div>
                <p class="eyebrow">Filter</p>
                <strong>Pick a show</strong>
              </div>
              <button type="button" class="icon-button" aria-label="Close show picker" data-action="click->show-picker#close">‚úï</button>
            </div>
            <div class="show-picker-options">
              <button type="button" class="show-picker-option" data-id="" data-name="All shows" data-emoji="‚ú≥Ô∏è" data-action="click->show-picker#select" data-show-picker-target="option">
                <span class="emoji">‚ú≥Ô∏è</span>
                <div>
                  <strong>All shows</strong>
                  <p class="muted small">Search across everything</p>
                </div>
              </button>

              <% @shows.each do |show| %>
                <button type="button" class="show-picker-option" data-id="<%= show.id %>" data-name="<%= show.name %>" data-emoji="<%= show.emoji.presence || "üì∫" %>" data-action="click->show-picker#select" data-show-picker-target="option">
                  <span class="emoji"><%= show.emoji.presence || "üì∫" %></span>
                  <div>
                    <strong><%= show.name %></strong>
                    <% if show.description.present? %>
                      <p class="muted small"><%= truncate(show.description, length: 80) %></p>
                    <% end %>
                  </div>
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      <p class="hint voice-status" data-voice-search-target="status" hidden></p>
    <% end %>
  </section>

  <turbo-frame id="episode_results" data-controller="voice-answer" data-voice-answer-endpoint-value="<%= voice_response_path %>">
    <% if @episodes.any? %>
      <ul class="episode-list">
        <% @episodes.each_with_index do |episode, index| %>
          <% admin_data = {} %>
          <% if current_admin_user %>
            <% admin_data[:controller] = "episode-image" %>
            <% admin_data[:"episode-image-refresh-url-value"] = refresh_image_episode_path(episode) %>
            <% admin_data[:"episode-image-title-value"] = episode.title %>
          <% end %>
          <% voice_data = { "voice-answer-target": "episode", "voice-answer-title": episode.title, "voice-answer-alternate-titles": (episode.alternate_titles || []).join("|"), "voice-answer-season-number": episode.season_number, "voice-answer-episode-number": episode.episode_number } %>
          <% combined_data = admin_data.merge(voice_data) %>
          <li class="episode-card"<%= tag.attributes(data: combined_data) if combined_data.any? %>>
            <%= link_to episode_path(episode), data: { turbo_frame: "_top" } do %>
              <div class="episode-thumbnail" data-episode-image-target="thumbnail">
                <% if episode.display_image_url.present? %>
                  <%= image_tag episode.display_image_url, alt: episode.title, loading: "lazy", data: { "episode-image-target": "image", controller: (current_admin_user ? nil : "image-bust"), action: (current_admin_user ? nil : "error->image-bust#retry") } %>
                <% elsif current_admin_user %>
                  <div class="muted small">No image cached</div>
                <% end %>
              </div>
              <div class="episode-meta">
                <span class="eyebrow"><%= episode.show&.name %></span>
                <strong><%= highlight_query(episode.title, @query) %></strong>
                <% if episode.alternate_titles.present? %>
                  <p class="muted small">
                    Also called:
                    <%= episode.alternate_titles.map { |alt| highlight_query(alt, @query) }.join(", ").html_safe %>
                  </p>
                <% end %>
                <p class="muted">
                  <% if episode.season_number && episode.episode_number %>
                    S<%= episode.season_number %> ¬∑ E<%= episode.episode_number %>
                  <% end %>
                  <% if episode.aired_on %>
                    ¬∑ <%= episode.aired_on.to_fs(:long) %>
                  <% end %>
                </p>
              </div>
              <% if episode.description.present? %>
                <p class="description"><%= highlight_query(truncate(episode.description, length: 160), @query) %></p>
              <% end %>
            <% end %>
            <% if current_admin_user %>
              <div class="admin-image-actions" data-episode-image-target="adminActions">
                <p class="muted small" data-episode-image-target="status"><%= episode.display_image_url.present? ? "" : "No image cached" %></p>
                <%= link_to "Edit", edit_admin_episode_path(episode, return_to: request.fullpath), class: "button small" %>
                <button type="button" class="button small" data-action="episode-image#refresh" data-episode-image-target="button">
                  Refetch image
                </button>
              </div>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <div class="empty-state">
        <p>No episodes match that search yet.</p>
        <p class="muted">Try a different keyword or ask the admin to add more titles.</p>
      </div>
    <% end %>
  </turbo-frame>
</div>
