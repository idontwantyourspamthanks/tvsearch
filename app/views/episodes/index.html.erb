<% content_for :title, "Episode finder" %>

<div class="page">
  <section class="hero">
    <p class="eyebrow">TV episode finder</p>
    <h1>Search a curated set of episodes</h1>
    <p class="lede">Type a show name, episode title, or a plot detail to look up the episodes we currently track.</p>

    <%= form_with url: root_path, method: :get, data: { turbo_frame: "episode_results", controller: "live-search", action: "input->live-search#queue change->live-search#queue", "live-search-delay-value": 400 }, class: "search-form" do |form| %>
      <div class="search-box">
        <%= form.label :q, "Search", class: "sr-only" %>
        <%= form.search_field :q, value: @query, placeholder: "e.g. Dinner Party, plane crash, Hawkins lab", autofocus: true %>
        <%= form.collection_select :show_id, @shows, :id, :name, { include_blank: "All shows" }, { class: "select" } %>
        <%= form.submit "Search" %>
      </div>
      <p class="hint">Filter by title, description, nickname, or show.</p>
    <% end %>
  </section>

  <turbo-frame id="episode_results">
    <% if @episodes.any? %>
      <ul class="episode-list">
        <% @episodes.each do |episode| %>
          <li class="episode-card">
            <%= link_to episode_path(episode), data: { turbo_frame: "_top" } do %>
              <% if episode.image_url %>
                <div class="episode-thumbnail">
                  <%= image_tag episode.image_url, alt: episode.title, loading: "lazy" %>
                </div>
              <% end %>
              <div class="episode-meta">
                <span class="eyebrow"><%= episode.show&.name %></span>
                <strong><%= highlight_query(episode.title, @query) %></strong>
                <% if episode.alternate_titles.present? %>
                  <p class="muted small">
                    Also called:
                    <%= episode.alternate_titles.map { |alt| highlight_query(alt, @query) }.join(", ").html_safe %>
                  </p>
                <% end %>
                <p class="muted">
                  <% if episode.season_number && episode.episode_number %>
                    S<%= episode.season_number %> · E<%= episode.episode_number %>
                  <% end %>
                  <% if episode.aired_on %>
                    · <%= episode.aired_on.to_fs(:long) %>
                  <% end %>
                </p>
              </div>
              <% if episode.description.present? %>
                <p class="description"><%= highlight_query(truncate(episode.description, length: 160), @query) %></p>
              <% end %>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <div class="empty-state">
        <p>No episodes match that search yet.</p>
        <p class="muted">Try a different keyword or ask the admin to add more titles.</p>
      </div>
    <% end %>
  </turbo-frame>
</div>
